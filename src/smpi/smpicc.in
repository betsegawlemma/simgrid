#! /bin/bash

CC=@CMAKE_C_COMPILER@

INCLUDEARGS="-I@includedir@ -I@includedir@/smpi -I@CMAKE_BINARY_DIR@/include"
CMAKE_LINKARGS="-L@CMAKE_LINKARGS@"

if [ "@WIN32@" != "1" ]; then
  LINKARGS="-lsimgrid -lsmpi -lm"
  CFLAGS="-O2 -Dmain=smpi_simulated_main"
else
  CFLAGS="-O2 -include @includedir@/smpi/smpi_main.h"
  LINKARGS="@CMAKE_BINARY_DIR@\lib\libsimgrid.dll @CMAKE_BINARY_DIR@\lib\libsmpi.dll"
fi

CMDLINE=""
while [ -n "$1" ]; do
  ARG="$1"
  shift
  case "${ARG}" in
   -c)
      LINKARGS=""
      CMDLINE="${CMDLINE} -c "
      ;;
   *.c)
      SRCFILE="$(readlink -f ${ARG} 2>/dev/null)"
      if [ -z $SRCFILE ] ; then
         SRCFILE="$ARG"
      fi
      CMDLINE="${CMDLINE} ${SRCFILE} "
      ;;
   *)
      CMDLINE="${CMDLINE} ${ARG} "
      ;;
  esac
done

CMDLINE="${CC} ${CFLAGS} ${CMDLINE} ${INCLUDEARGS} ${CMAKE_LINKARGS} ${LINKARGS}"

#echo "${CMDLINE}"
${CMDLINE}
